// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Video {
  videoId       String   @id @map("video_id")
  title         String
  channelId     String   @map("channel_id")
  channelTitle  String   @map("channel_title")
  publishedAt   DateTime @map("published_at")
  durationSeconds Int    @map("duration_seconds")
  isShort       Boolean  @map("is_short")
  thumbnailUrl  String   @map("thumbnail_url")
  viewCount     BigInt   @map("view_count")
  likeCount     BigInt?  @map("like_count")
  commentCount  BigInt?  @map("comment_count")
  firstSeenAt   DateTime @default(now()) @map("first_seen_at")
  lastSeenAt    DateTime @updatedAt @map("last_seen_at")
  
  feedHits      FeedHit[]

  @@map("videos")
}

model CollectorRun {
  runId      String   @id @default(uuid()) @map("run_id")
  startedAt  DateTime @default(now()) @map("started_at")
  finishedAt DateTime? @map("finished_at")
  status     String   @default("running") // running | ok | error
  error      String?
  
  feedHits   FeedHit[]

  @@map("collector_runs")
}

model FeedHit {
  id            String   @id @default(uuid())
  runId         String   @map("run_id")
  videoId       String   @map("video_id")
  regionCode    String   @map("region_code")
  categoryId    String   @map("category_id")
  seenAt        DateTime @default(now()) @map("seen_at")
  viewsPerHour  Float    @map("views_per_hour")
  bucket        String   // viral | stable | low
  nicheTags     String[] @map("niche_tags")
  
  run           CollectorRun @relation(fields: [runId], references: [runId])
  video         Video        @relation(fields: [videoId], references: [videoId])

  @@index([videoId, regionCode, categoryId, seenAt])
  @@index([nicheTags])
  @@index([regionCode])
  @@index([bucket])
  @@index([seenAt])
  @@map("feed_hits")
}
